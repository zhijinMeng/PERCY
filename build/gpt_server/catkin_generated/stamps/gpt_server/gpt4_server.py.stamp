#! /usr/bin/python3

import rospy
import sys

print('PYTHON VERSION:')
print(sys.version)
from gpt_server.srv import GPTGenerate, GPTGenerateRequest, GPTGenerateResponse
from openai import OpenAI
import json
import sys

from std_msgs.msg import Bool



class GPT:
    """
    ChatGPT server class.
    This will run in the background, waiting for a request to be made.
    GPT server accepts a string as request and outputs a string generated by ChatGPT.
    """

    def __init__(self):
        rospy.init_node('gpt_server')

        self.automatic_sub = rospy.Service('is_automatic_mode', Bool, self.OnOpModeChanged)
        self.automatic_mode = True

        self.service = rospy.Service('gpt_generate', GPTGenerate, self.OnRequest)

        rospy.loginfo('GPT node started')
        self.id = rospy.get_param('~id', '0')
        self.file_name = f'{self.id}.json'
        self.save_filepath = f'/home/robocupathome/workspace/eddy_code/src/DATA/{self.file_name}'

        self.manual_question_received = False

        # Here, initialize ChatGPT-3.5 Turbo
        
        self.client = OpenAI(api_key="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")

        API_KEY = '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'
        OpenAI.api_key = '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'
        self.messages = [ {"role": "system", 
                                "content":  "Have a conversation with me. Please respond in English only!"} ] 

        ## file readings
        # json_file_path = '/home/ubuntu/pt0/src/gpt_server/scripts/profile.json'
        # try:
        #     with open(json_file_path, 'r') as file:
        #         self.messages = json.load(file)
        #         print('Successfully loaded JSON file:')
        #         print(self.messages)
        # except FileNotFoundError:
        #     print(f"Error: File not found at {json_file_path}")
        # except json.JSONDecodeError as e:
        #     print(f"Error decoding JSON: {e}")
        # self.messages.append({"role":"system","content":"ask me a question about my hobby."})


    def OnOpModeChanged(self, data: Bool):
        self.automatic_mode = data.data


    def OnRequest(self, data: GPTGenerateRequest):
        s = data.request.split('q: ')

        if len(s) > 1:
            self.manual_question_received = True
            manual_question = s[1]
            print('Manual question detected')
            input_text = {"role": "assistant", "content": manual_question}
            self.messages.append(input_text)

            print('Manual question saved')
            return 'Manual question inserted'
        
        if self.manual_question_received:
            response_to_manual_question = data.request
            self.messages.append({"role": "user", "content": response_to_manual_question})

            self.manual_question_received = False
            return 'Acknowledged.'


        text_from_speech = data.request  # Speech recognized by the user

        initialEmotion = data.initialEmotion
        finalEmotion = data.finalEmotion

        print(f'Receive emotions: {initialEmotion}, {finalEmotion}')

        input_text = {"role": "user", "content": text_from_speech}

        # Append the user's input to the conversation
        self.messages.append(input_text)

        # Get a response from ChatGPT-3.5 Turbo
        response = self.get_openai_response(self.messages)

        # Append the response to the conversation
        self.messages.append({"role": "assistant", "content": response})

        print(f'Received a request with a prompt:\n{input_text}')

        # Save the conversation to a JSON file




        return response

    def get_openai_response(self, messages):
        # chat = self.client.chat.completions.create(model="gpt-3.5-turbo", messages=messages)
        chat = self.client.chat.completions.create(model="gpt-4", messages=messages)
        reply = chat.choices[0].message.content 
        return reply
        # return GPTGenerateResponse(response=reply)

    def Dump(self):
        with open(self.save_filepath, 'w') as json_file:
            json.dump(self.messages, json_file)



if __name__ == '__main__':
   
    
    gpt = GPT()
    rospy.spin()

    print('History dumped.')
    gpt.Dump()
       
